<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C2 Management</title>

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="website icon" type="png" href="icon.png" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: { sans: ['Nunito', 'sans-serif'] },
                extend: {
                    colors: {
                        primary: '#009a86',
                        darkbg: '#1a1a1a',
                        darkcard: '#2d2d2d',
                    },
                },
            },
        };
    </script>

    <style>
        .dropdown-content { display: none; position: static; width: 100%; }
        .dropdown.active .dropdown-content { display: block; }

        .chatbot-container {
            display: none; position: fixed; bottom: 100px; right: 100px;
            width: 300px; height: 400px; background: white; border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000;
        }
        .chatbot-container.active { display: block; }

        /* Responsive sidebar */
        @media (max-width: 768px) {
            .sidebar-collapsed { width: 80px !important; overflow: hidden; }
            .sidebar-collapsed .nav-text { display: none; }
            .sidebar-collapsed .dropdown-content { display: none !important; }
            .sidebar-collapsed .user-info { display: none; }
            .sidebar-collapsed .logo-expanded { display: none; }
            .sidebar-collapsed .logo-collapsed { display: block !important; }
        }
        .logo-collapsed { display: none; }
        .sidebar-toggle-arrow { transition: transform 0.3s ease; }
        .sidebar-collapsed .sidebar-toggle-arrow { transform: rotate(180deg); }
    </style>
</head>

<body class="bg-gray-100 dark:bg-darkbg font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="hidden md:flex md:flex-shrink-0 transition-all duration-300 ease-in-out">
            <div class="flex flex-col w-64 bg-white text-black dark:bg-darkcard dark:text-white">
                <!-- Logo and Toggle -->
                <div class="flex items-center justify-between h-16 px-4 border-b dark:border-gray-700">
                    <div class="flex items-center">
                        <img src="c2o-ms-Dark-asideLOGO.gif" alt="nav logo" class="h-12 w-auto block dark:hidden logo-expanded" />
                        <img src="c2o-ms-light-asideLOGO.gif" alt="nav logo" class="h-12 w-auto hidden dark:block logo-expanded" />
                    </div>
                </div>

                <!-- Navigation Links -->
                <nav class="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                    <a href="#" class="flex items-center px-4 py-2 text-black bg-primary hover:bg-gray-200 transition-colors rounded-lg dark:text-white dark:hover:bg-gray-700">
                        <i class="fas fa-home mr-3 w-5 text-center"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>

                    <!-- Profile Dropdown -->
                    <div class="dropdown">
                        <button class="flex items-center justify-between w-full px-4 py-2 text-black rounded-lg hover:bg-gray-200 transition-colors dark:text-white dark:hover:bg-gray-700">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-3 w-5 text-center"></i>
                                <span class="nav-text">My Profile</span>
                            </div>
                            <i class="fas fa-chevron-down ml-2 transition-transform duration-200 dropdown-arrow nav-text"></i>
                        </button>
                        <div class="dropdown-content pl-8 space-y-1">
                            <a href="personal.html" class="flex items-center px-4 py-2 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                                <i class="fas fa-id-card mr-3 w-5 text-center"></i>
                                <span class="nav-text">Personal</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                                <i class="fas fa-file-invoice-dollar mr-3 w-5 text-center"></i>
                                <span class="nav-text">Payslips</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                                <i class="fas fa-clipboard-list mr-3 w-5 text-center"></i>
                                <span class="nav-text">Q Board</span>
                            </a>
                            <a href="#" class="flex items-center px-4 py-2 text-black dark:text-white hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg">
                                <i class="fas fa-file-contract mr-3 w-5 text-center"></i>
                                <span class="nav-text">Policy</span>
                            </a>
                        </div>
                    </div>

                    <a href="#" class="flex items-center px-4 py-2 text-black rounded-lg hover:bg-gray-300 transition-colors dark:text-white dark:hover:bg-gray-700">
                        <i class="fas fa-calendar-alt mr-3 w-5 text-center"></i>
                        <span class="nav-text">My Rota</span>
                    </a>

                    <a href="#" class="flex items-center px-4 py-2 text-black rounded-lg hover:bg-gray-300 transition-colors dark:text-white dark:hover:bg-gray-700">
                        <i class="fas fa-calendar-day mr-3 w-5 text-center"></i>
                        <span class="nav-text">Public Events</span>
                    </a>

                    <a href="#" class="flex items-center px-4 py-2 text-black rounded-lg hover:bg-gray-300 transition-colors dark:text-white dark:hover:bg-gray-200">
                        <i class="fas fa-cog mr-3 w-5 text-center"></i>
                        <span class="nav-text">Settings</span>
                    </a>
                </nav>

                <!-- User Profile -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 user-info">
                    <div class="flex items-center">
                        <img class="w-10 h-10 rounded-full" src="1.jpeg" alt="User avatar" />
                        <div class="ml-3">
                            <p class="text-sm font-medium dark:text-white">Admin</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">c2o.ms.net</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="bg-white shadow-sm dark:bg-darkcard">
                <div class="px-4 py-4 flex justify-between items-center">
                    <h1 class="text-2xl font-semibold text-gray-800 dark:text-white"></h1>
                    <!-- Mobile menu button -->
                    <button id="mobileMenuButton" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto bg-gray-100 dark:bg-darkbg p-4">
                <!-- Search Bar -->
                <div class="max-w-md mx-auto mb-6">
                    <div class="relative">
                        <input type="text" placeholder="Search..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-darkcard focus:outline-none focus:ring-2 focus:ring-primary" />
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Left Column (Greeting and Shift Box) -->
                    <div class="w-full md:w-1/2 space-y-4">
                        <!-- Greeting Box with Weather -->
                        <div class="bg-white rounded-xl shadow-md p-6 dark:bg-darkcard">
                            <!-- Time and Date -->
                            <div class="flex justify-between items-center mb-4">
                                <div class="text-2xl font-semibold text-black dark:text-white" id="current-time">
                                    <i class="fas fa-clock mr-2"></i><span id="time">17:26</span>
                                </div>
                                <div class="text-gray-600 dark:text-gray-400" id="current-date">
                                    <i class="fas fa-calendar-day mr-2"></i><span id="date">Wed, 13 Aug</span>
                                </div>
                            </div>

                            <!-- Greeting Message with Weather -->
                            <div class="mb-4 flex items-center justify-between">
                                <div>
                                    <h2 class="text-3xl font-bold text-primary dark:text-[#009a86]" id="greeting">
                                        <i id="greetingIcon" class="fas fa-sun mr-2"></i>GOOD AFTERNOON!
                                    </h2>
                                    <div class="flex items-center mt-2">
                                        <img id="weatherIcon" src="https://openweathermap.org/img/wn/01d@2x.png" alt="Weather icon" class="h-8 w-8" />
                                        <span id="weatherTemp" class="ml-2 text-lg">24°C</span>
                                        <span id="weatherDesc" class="ml-2 text-gray-600 dark:text-gray-400">Sunny, ISB</span>
                                    </div>
                                </div>
                                <div>
                                    <p class="text-lg font-semibold text-black dark:text-white">
                                        <i class="fas fa-user mr-2"></i>Muhammad Umar Gul
                                    </p>
                                    <p class="text-gray-600 dark:text-gray-400 mt-2">
                                        <i class="fas fa-comment-dots mr-2"></i>Remember every good conversation starts with listening...
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Today's Shift Box -->
                        <div class="bg-white rounded-xl shadow-md p-6 dark:bg-darkcard">
                            <h3 class="text-xl font-bold text-black dark:text-white mb-4">
                                <i class="fas fa-business-time mr-2"></i>TODAY'S SHIFT
                            </h3>
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-4">
                                <p class="text-lg font-semibold text-black dark:text-white">
                                    <i class="fas fa-building mr-2"></i>C20 MANAGEMENT
                                </p>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-play-circle mr-2"></i>Start:</p>
                                    <p class="text-black dark:text-white font-semibold">10:00</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-sign-in-alt mr-2"></i>Clock-In At:</p>
                                    <p class="text-black dark:text-white font-semibold">10:00</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-hourglass-half mr-2"></i>Schedule Hours:</p>
                                    <p class="text-black dark:text-white font-semibold">8H 0M</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-stop-circle mr-2"></i>End:</p>
                                    <p class="text-black dark:text-white font-semibold">18:00</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-sign-out-alt mr-2"></i>Clock-Out At:</p>
                                    <p class="text-black dark:text-white font-semibold">18:28</p>
                                </div>
                                <div>
                                    <p class="text-gray-600 dark:text-gray-400"><i class="fas fa-history mr-2"></i>Actual Hours:</p>
                                    <p class="text-black dark:text-white font-semibold">---</p>
                                </div>
                            </div>

                            <div class="mt-6 text-center">
                                <p class="text-green-500 font-bold text-lg mb-4">
                                    <i class="fas fa-check-circle mr-2"></i>ON TIME
                                </p>
                                <button class="bg-red-600 text-white py-3 px-6 rounded-lg font-semibold w-full hover:bg-opacity-90 transition-colors">
                                    <i class="fas fa-door-open mr-2"></i>CLOCK OUT
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column (Announcement) -->
                    <div class="w-full md:w-1/2 space-y-4">
                        <div class="bg-white rounded-xl shadow-md p-6 dark:bg-darkcard h-90%">
                            <h3 class="text-xl font-bold text-black dark:text-white mb-4">
                                <i class="fas fa-bullhorn mr-2"></i>Announcement
                            </h3>
                            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-2 text-center h-80 flex items-center justify-center">
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    <i class="fas fa-database mr-2"></i>NO DATA
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Chatbot Container -->
    <div id="chatbotContainer" class="chatbot-container dark:bg-darkcard dark:text-white">
        <div class="p-4 border-b dark:border-gray-600">
            <h3 class="font-bold"><i class="fas fa-robot mr-2"></i>Hey! I'm Your C2O MS</h3>
            <button id="closeChatbot" class="float-right text-gray-500 hover:text-gray-700 dark:hover:text-gray-300" aria-label="Close chatbot">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4 h-64 overflow-y-auto" id="chatMessages">
            <div class="text-center text-gray-500 dark:text-gray-400 mt-20">
                <i class="fas fa-comments text-4xl mb-4"></i>
                <p>How can we help you today?</p>
            </div>
        </div>
        <div class="p-4 border-t dark:border-gray-600">
            <div class="flex">
                <input type="text" placeholder="Type your message..." id="chatInput" class="w-full p-2 rounded-l border dark:bg-darkbg dark:border-gray-600" />
                <button id="sendMessage" class="bg-primary text-white px-4 py-2 rounded-r">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Floating Buttons -->
    <div class="fixed bottom-6 right-6 flex space-x-4">
        <button id="chatbotToggle" class="p-4 bg-primary rounded-full text-white shadow-lg hover:bg-opacity-90 transition-colors" aria-label="Toggle chatbot">
            <i class="fas fa-comment-dots text-xl"></i>
        </button>
        <button id="darkModeToggle" class="p-4 bg-black rounded-full text-white shadow-lg hover:bg-gray-800 transition-colors" aria-label="Toggle dark mode">
            <i id="darkIcon" class="fas fa-moon text-xl dark:hidden"></i>
            <i id="lightIcon" class="fas fa-sun text-xl hidden dark:block"></i>
        </button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const darkIcon = document.getElementById('darkIcon');
            const lightIcon = document.getElementById('lightIcon');
            const chatbotToggle = document.getElementById('chatbotToggle');
            const closeChatbot = document.getElementById('closeChatbot');
            const chatbotContainer = document.getElementById('chatbotContainer');
            const chatInput = document.getElementById('chatInput');
            const sendMessage = document.getElementById('sendMessage');
            const chatMessages = document.getElementById('chatMessages');
            const dropdowns = document.querySelectorAll('.dropdown');
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle'); // may be null (guard below)
            const mobileMenuButton = document.getElementById('mobileMenuButton');

            // ==== Dark mode ====
            function initDarkMode() {
                const isDark = localStorage.getItem('darkMode') === 'true' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
                document.documentElement.classList.toggle('dark', isDark);
                updateIcons();
            }
            function updateIcons() {
                const isDark = document.documentElement.classList.contains('dark');
                darkIcon.classList.toggle('hidden', isDark);
                lightIcon.classList.toggle('hidden', !isDark);
            }
            darkModeToggle.addEventListener('click', function () {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', isDark);
                updateIcons();
            });

            // ==== Chatbot open/close ====
            chatbotToggle.addEventListener('click', function () { chatbotContainer.classList.toggle('active'); });
            closeChatbot.addEventListener('click', function () { chatbotContainer.classList.remove('active'); });

            // ==== Chat UI helpers ====
            function addMessage(text, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-2 p-2 rounded-lg ${sender === 'user' ? 'bg-primary text-white ml-auto max-w-xs' : 'bg-gray-200 dark:bg-gray-700 mr-auto max-w-xs'}`;
                messageDiv.textContent = text;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function addTypingIndicator() {
                const div = document.createElement('div');
                const id = 'typing-' + Date.now();
                div.id = id;
                div.className = 'mb-2 p-2 rounded-lg bg-gray-200 dark:bg-gray-700 mr-auto max-w-xs italic opacity-80';
                div.textContent = 'C2O is typing…';
                chatMessages.appendChild(div);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return id;
            }
            function removeTypingIndicator(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            // ==== YOUR BOT ENDPOINT (ngrok) ====
            const BOT_ENDPOINT = 'https://ac39a92549b4.ngrok-free.app/chat';

            async function sendToBot(userText) {
                // Adjust body key if your server expects something else (e.g., { query: userText } or { prompt: userText })
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000); // 30s timeout
                try {
                    const res = await fetch(BOT_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userText }),
                        signal: controller.signal,
                    });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error('HTTP ' + res.status);

                    const ct = res.headers.get('content-type') || '';
                    if (ct.includes('application/json')) {
                        const data = await res.json();
                        // Try common field names; fallback to stringify whole object
                        return (
                            data.reply ||
                            data.message ||
                            data.response ||
                            data.answer ||
                            (typeof data === 'string' ? data : JSON.stringify(data))
                        );
                    } else {
                        return await res.text();
                    }
                } catch (err) {
                    throw err;
                }
            }

            // Send handlers (button + Enter)
            sendMessage.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSend();
                }
            });

            async function handleSend() {
                const message = chatInput.value.trim();
                if (!message) return;
                addMessage(message, 'user');
                chatInput.value = '';
                const typingId = addTypingIndicator();
                sendMessage.disabled = true;
                try {
                    const reply = await sendToBot(message);
                    removeTypingIndicator(typingId);
                    addMessage(reply, 'bot');
                } catch (e) {
                    removeTypingIndicator(typingId);
                    addMessage("Sorry, I couldn't reach the chatbot server. Please try again.", 'bot');
                    console.error(e);
                } finally {
                    sendMessage.disabled = false;
                }
            }

            // ==== Dropdowns ====
            dropdowns.forEach((dropdown) => {
                const button = dropdown.querySelector('button');
                const arrow = dropdown.querySelector('.dropdown-arrow');
                button.addEventListener('click', function (e) {
                    e.preventDefault();
                    dropdown.classList.toggle('active');
                    arrow.classList.toggle('rotate-180');
                    dropdowns.forEach((other) => {
                        if (other !== dropdown) {
                            other.classList.remove('active');
                            const a = other.querySelector('.dropdown-arrow');
                            if (a) a.classList.remove('rotate-180');
                        }
                    });
                });
            });
            document.addEventListener('click', function (e) {
                if (!e.target.closest('.dropdown')) {
                    dropdowns.forEach((d) => {
                        d.classList.remove('active');
                        const a = d.querySelector('.dropdown-arrow');
                        if (a) a.classList.remove('rotate-180');
                    });
                }
            });

            // ==== Sidebar & Mobile menu ====
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () { sidebar.classList.toggle('sidebar-collapsed'); });
            }
            mobileMenuButton.addEventListener('click', function () { sidebar.classList.toggle('hidden'); });

            // ==== Time, Date, Greeting ====
            function updateTime() {
                const now = new Date();
                const timeElement = document.getElementById('time');
                const hours = now.getHours().toString().padStart(2, '0');
                const minutes = now.getMinutes().toString().padStart(2, '0');
                timeElement.textContent = `${hours}:${minutes}`;

                const dateElement = document.getElementById('date');
                const options = { weekday: 'short', day: 'numeric', month: 'short' };
                dateElement.textContent = now.toLocaleDateString('en-US', options);

                const greetingElement = document.getElementById('greeting');
                const hour = now.getHours();
                if (hour < 12) {
                    greetingElement.innerHTML = '<i class="fas fa-sun mr-2"></i>GOOD MORNING!';
                } else if (hour < 18) {
                    greetingElement.innerHTML = '<i class="fas fa-sun mr-2"></i>GOOD AFTERNOON!';
                } else {
                    greetingElement.innerHTML = '<i class="fas fa-moon mr-2"></i>GOOD EVENING!';
                }
            }
            updateTime();
            setInterval(updateTime, 60000);

            // Weather placeholder to avoid ReferenceError (implement later if needed)
            function getWeather() { /* no-op */ }

            // Initialize on page load
            initDarkMode();
            getWeather();

            // React to system preference changes if user hasn't set a preference
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function () {
                if (!localStorage.getItem('darkMode')) initDarkMode();
            });
        });
    </script>
</body>
</html>
